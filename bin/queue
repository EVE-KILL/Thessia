#!/usr/bin/env bun

// Import the register file before any other imports
import '../server/register-alias.js';

import { Command } from 'commander';
import path from 'node:path';
import fs from 'node:fs/promises';
import { initMongooseConnection } from '../server/helpers/Mongoose';

const program = new Command();
await initMongooseConnection();

async function main() {
    const cliPath = path.join(__dirname, '../src/queue');
    const files = await fs.readdir(cliPath);

    for (const file of files) {
        const { default: commandModule } = await import(path.join(cliPath, file));
        program
            .command(commandModule.name)
            .description(commandModule.description)
            .action((...args) => commandModule.run(args));
    }

    program.parse(process.argv);
    program.exitOverride((error) => {
        console.log(error);
    });
}

main().catch((error) => {
    console.error(error);
    process.exit(1);
});
